- hosts: hosts
  become: true
  vars_files:
    - variables/default.yaml
  tasks:
    - name: Ensure prerequisites installed for docker
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg2
          - software-properties-common
        update_cache: yes

    - name: Ensure Docker GPG Key is present
      apt_key: url=https://download.docker.com/linux/ubuntu/gpg

    - name: Ensure Docker APT Repository is present
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/{{ansible_distribution|lower}} {{ansible_distribution_release}} stable

    - name: Ensure Docker is intalled
      apt:
        name: docker-ce
        update_cache: yes

    - name: Ensure python docker is installed
      pip:
        name: 
          - docker

    - name: Ensure configuration is present
      copy:
        src: ./config/
        dest: ./data/bitwarden_vps_docker/

    - name: Create docker container for caddy
      docker_container:
        name: caddy
        image: abiosoft/caddy
        state: started
        env:
          CADDYPATH: /etc/caddycerts
          ACME_AGREE: "true"
          DOMAIN: "{{ default.domain }}"
        volumes:
          - ./caddy:/etc/caddycerts
          - ./data/bitwarden_vps_docker/caddy/Caddyfile:/etc/Caddyfile
        ports:
          - 80:80
          - 443:443
    - name: Create docker container for bitwarden
      docker_container:
        name: bitwarden
        image: bitwardenrs/server
        state: started
        volumes:
          - ./data/bitwarden_vps_docker/bitwarden:/data

    - name: Ensure containers are connected to correct network
      docker_network:
        name: bitwarden_vps_docker
        connected:
          - bitwarden
          - caddy